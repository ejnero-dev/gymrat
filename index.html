<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymFlow - Tu Entrenamiento Personal</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Tracking de entrenamientos de gimnasio - Tu rutina personalizada">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GymFlow">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">

    <!-- Twitter Embed SDK -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme Colors */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #2a2a2a;
            --bg-card-hover: #333333;

            /* Accent Colors */
            --accent-teal: #2d8a7b;
            --accent-teal-light: #3da696;
            --accent-coral: #e07a5f;
            --accent-coral-light: #eb9a85;
            --accent-gold: #c9a227;

            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;

            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;

            /* Borders & Shadows */
            --border-color: #333333;
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.3);

            /* Legacy compatibility */
            --primary: var(--accent-teal);
            --secondary: var(--accent-coral);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 80px;
        }

        /* ============================================
           APP CONTAINER
        ============================================ */
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        /* ============================================
           APP HEADER - Weekly Goal
        ============================================ */
        .app-header {
            background: linear-gradient(135deg, var(--accent-teal) 0%, #1a5c52 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 24px 24px;
        }

        .weekly-goal {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-ring {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
        }

        .progress-ring::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 4px solid var(--accent-gold);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-45deg);
        }

        .goal-count {
            font-size: 16px;
            font-weight: 800;
            color: white;
        }

        .goal-text {
            display: flex;
            flex-direction: column;
        }

        .goal-text .label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .goal-text .action {
            font-size: 14px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        .best-streak {
            text-align: right;
        }

        .best-streak .label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
        }

        .best-streak .value {
            font-size: 18px;
            font-weight: 800;
            color: white;
        }

        /* ============================================
           MAIN CONTENT
        ============================================ */
        .main-content {
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* ============================================
           WEEK CALENDAR
        ============================================ */
        .week-calendar {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .week-header span:first-child {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .week-progress {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-cell:hover {
            background: var(--bg-card-hover);
        }

        .day-cell.today {
            background: var(--bg-card-hover);
        }

        .day-cell.completed .day-number {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .day-cell.completed .day-number::after {
            content: '‚úì';
            position: absolute;
            font-size: 12px;
            font-weight: 800;
        }

        .day-letter {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .day-number {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
        }

        /* ============================================
           CTA BUTTON
        ============================================ */
        .cta-button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-coral-light) 100%);
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(224, 122, 95, 0.3);
        }

        .cta-button:active {
            transform: scale(0.98);
        }

        /* ============================================
           SECTION HEADERS
        ============================================ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-header span {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-header a {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-coral);
            text-decoration: none;
        }

        /* ============================================
           RECENT WORKOUTS - Horizontal Scroll
        ============================================ */
        .recent-workouts {
            margin-bottom: 24px;
        }

        .workouts-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .workouts-scroll::-webkit-scrollbar {
            display: none;
        }

        .workout-card {
            flex: 0 0 160px;
            scroll-snap-align: start;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .workout-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-teal);
        }

        .workout-icon {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .workout-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .workout-date {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .workout-exercises {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .no-workouts {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ============================================
           MONTHLY PROGRESS
        ============================================ */
        .monthly-progress {
            margin-bottom: 24px;
        }

        .months-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .months-scroll::-webkit-scrollbar {
            display: none;
        }

        .month-card {
            flex: 0 0 140px;
            scroll-snap-align: start;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .month-card.current {
            border-color: var(--accent-coral);
        }

        .month-card .month-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .month-card .month-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .month-card .progress-bar {
            height: 4px;
            background: var(--bg-card-hover);
            border-radius: 2px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .month-card .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .month-card .progress-fill.coral {
            background: var(--accent-coral);
        }

        .month-card .progress-fill.green {
            background: var(--success);
        }

        .month-card .workout-count {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .month-card .workout-count strong {
            color: var(--accent-coral);
        }

        /* ============================================
           BOTTOM NAVIGATION
        ============================================ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-icon {
            font-size: 24px;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        .nav-item.active .nav-label {
            color: var(--accent-coral);
        }

        /* ============================================
           ROUTINE SELECTOR MODAL
        ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--accent-teal) 0%, #1a5c52 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Routine Options */
        .routine-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .routine-option:hover {
            border-color: var(--accent-teal);
            background: var(--bg-card-hover);
        }

        .routine-option:last-child {
            margin-bottom: 0;
        }

        .routine-emoji {
            font-size: 32px;
        }

        .routine-info h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .routine-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .modal-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .modal-btn.cancel:active {
            background: var(--bg-card-hover);
        }

        /* ============================================
           WORKOUT VIEW (During Exercise)
        ============================================ */
        .workout-view {
            padding: 0;
        }

        .workout-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .back-btn {
            background: var(--bg-card);
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .back-btn:active {
            background: var(--bg-card-hover);
        }

        .workout-header-info {
            flex: 1;
        }

        .workout-header-info h2 {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .workout-header-info .progress {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .workout-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .workout-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Exercise List */
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .exercise-item {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .exercise-item:active {
            transform: scale(0.98);
        }

        .exercise-item.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .exercise-item.active {
            background: rgba(45, 138, 123, 0.1);
            border-color: var(--accent-teal);
        }

        .exercise-status {
            font-size: 24px;
            flex-shrink: 0;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .exercise-last {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
        }

        /* Finish Workout Button */
        .finish-workout-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent-teal);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .finish-workout-btn:active {
            transform: scale(0.98);
        }

        /* ============================================
           EXERCISE DETAIL VIEW
        ============================================ */
        .exercise-view {
            display: none;
        }

        .exercise-view.active {
            display: block;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .exercise-header-info h2 {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .exercise-header-info .progress {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Video Section */
        .video-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .video-section .placeholder {
            background: var(--bg-card-hover);
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 12px;
        }

        .video-embed-container {
            width: 100%;
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-card-hover);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-link {
            display: inline-block;
            padding: 10px 20px;
            background: #ff0000;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .video-link.twitter {
            background: #1DA1F2;
        }

        /* Current Set */
        .current-set {
            background: var(--bg-card);
            border: 3px solid var(--accent-teal);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .set-number {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent-teal);
            margin-bottom: 16px;
            text-align: center;
        }

        .set-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .set-input {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            text-align: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 56px;
            width: 100%;
        }

        .set-input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .complete-set-btn {
            width: 100%;
            padding: 18px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .complete-set-btn:active {
            transform: scale(0.98);
        }

        /* Rest Config Button */
        .rest-config-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .rest-config-btn:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        /* Rest Timer Inline */
        .rest-timer-inline {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            text-align: center;
        }

        .rest-timer-inline.active {
            display: block;
        }

        .rest-timer-inline .timer-display {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent-coral);
            margin-bottom: 12px;
        }

        .rest-timer-inline .timer-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .rest-timer-inline .timer-bar-fill {
            height: 100%;
            background: var(--accent-coral);
            transition: width 1s linear;
        }

        .rest-timer-inline .timer-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .skip-rest-btn {
            margin-top: 12px;
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Completed Sets */
        .completed-sets {
            margin-bottom: 24px;
        }

        .completed-sets h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .completed-set {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .completed-set .set-label {
            font-weight: 700;
            color: var(--success);
        }

        .completed-set .set-data {
            font-weight: 600;
            color: var(--text-primary);
        }

        .completed-set .set-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Last Workout */
        .last-workout {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .last-workout h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .last-workout-data {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Exercise Notes */
        .exercise-notes {
            margin-bottom: 24px;
        }

        .exercise-note-box {
            background: rgba(45, 138, 123, 0.1);
            border: 2px solid var(--accent-teal);
            border-radius: 12px;
            padding: 16px;
        }

        .exercise-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .exercise-note-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .exercise-note-edit-btn {
            background: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            color: var(--text-secondary);
        }

        .exercise-note-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .exercise-note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid var(--accent-teal);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .exercise-note-add-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--accent-teal);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-teal);
            cursor: pointer;
        }

        /* Tips */
        .tips {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .tips h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .tips p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Delete Last Set Button */
        .delete-last-set-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid var(--danger);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--danger);
            cursor: pointer;
            margin-top: 12px;
        }

        /* ============================================
           SUMMARY VIEW
        ============================================ */
        .summary-view {
            display: none;
            text-align: center;
        }

        .summary-view.active {
            display: block;
        }

        .summary-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .summary-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .summary-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .summary-stats {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary-stat {
            margin-bottom: 16px;
        }

        .summary-stat:last-child {
            margin-bottom: 0;
        }

        .summary-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .summary-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent-coral);
        }

        .back-to-home-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent-teal);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
        }

        /* ============================================
           SETTINGS VIEW
        ============================================ */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .settings-item-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-item-value {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Backup Section */
        .backup-section {
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
        }

        .backup-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .backup-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .backup-btn {
            padding: 14px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            color: var(--text-primary);
        }

        .backup-btn.export {
            color: var(--success);
            border-color: var(--success);
        }

        .backup-btn.import {
            color: var(--accent-teal);
            border-color: var(--accent-teal);
        }

        /* ============================================
           REST TIME CONFIG MODAL
        ============================================ */
        .rest-config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .rest-config-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .rest-config-input {
            width: 100px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .rest-config-input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        /* ============================================
           TIMER FLASH OVERLAY
        ============================================ */
        @keyframes timerFlash {
            0% { opacity: 0; }
            25% { opacity: 0.8; }
            50% { opacity: 0; }
            75% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .timer-flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-coral) 100%);
            z-index: 9999;
            pointer-events: none;
            animation: timerFlash 1s ease-in-out;
        }

        /* ============================================
           MOBILE ADJUSTMENTS
        ============================================ */
        @media (max-width: 480px) {
            .app-header {
                border-radius: 0;
            }

            .main-content {
                padding: 16px;
            }

            .week-days {
                gap: 4px;
            }

            .day-cell {
                padding: 6px 2px;
            }

            .day-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .workout-card {
                flex: 0 0 140px;
            }

            .month-card {
                flex: 0 0 120px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="weekly-goal">
                <div class="progress-ring">
                    <span class="goal-count" id="weeklyGoalCount">0/6</span>
                </div>
                <div class="goal-text">
                    <span class="label">META SEMANAL</span>
                    <span class="action" onclick="editWeeklyGoal()">Toca para editar</span>
                </div>
            </div>
            <div class="best-streak">
                <span class="label">MEJOR RACHA</span>
                <span class="value" id="bestStreakValue">0 sem</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- HOME VIEW -->
            <section id="homeView">
                <!-- Week Calendar -->
                <div class="week-calendar">
                    <div class="week-header">
                        <span>ESTA SEMANA</span>
                        <span class="week-progress" id="weekProgress">0 de 6</span>
                    </div>
                    <div class="week-days" id="weekDays"></div>
                </div>

                <!-- CTA Button -->
                <button class="cta-button" onclick="showRoutineSelector()">
                    + Iniciar Entrenamiento
                </button>

                <!-- Recent Workouts -->
                <section class="recent-workouts">
                    <div class="section-header">
                        <span>ENTRENAMIENTOS RECIENTES</span>
                        <a href="#" onclick="showView('progress'); return false;">Ver todo ‚Üí</a>
                    </div>
                    <div class="workouts-scroll" id="recentWorkouts"></div>
                </section>

                <!-- Monthly Progress -->
                <section class="monthly-progress">
                    <div class="section-header">
                        <span>PROGRESO MENSUAL</span>
                        <a href="#" onclick="showView('progress'); return false;">Ver todo ‚Üí</a>
                    </div>
                    <div class="months-scroll" id="monthlyProgress"></div>
                </section>
            </section>

            <!-- WORKOUT VIEW (Exercise List) -->
            <section id="workoutView" class="hidden">
                <div class="workout-view">
                    <div class="workout-header">
                        <button class="back-btn" onclick="cancelWorkout()">‚Üê Atr√°s</button>
                        <div class="workout-header-info">
                            <h2 id="workoutTitle">D√çA 1 - PECHO</h2>
                            <p class="progress" id="workoutSubtitle">4 ejercicios ‚Ä¢ 16 series</p>
                        </div>
                    </div>
                    <div class="exercise-list" id="exerciseList"></div>
                    <button class="finish-workout-btn" onclick="finishWorkout()">‚úì Terminar Entrenamiento</button>
                </div>
            </section>

            <!-- EXERCISE VIEW -->
            <section id="exerciseView" class="exercise-view">
                <div class="exercise-header">
                    <button class="back-btn" onclick="backToWorkout()">‚Üê Atr√°s</button>
                    <div class="exercise-header-info">
                        <h2 id="exerciseName">Press de Banca</h2>
                        <p class="progress" id="exerciseProgress">Ejercicio 1 de 4</p>
                    </div>
                </div>

                <!-- Video Section -->
                <div class="video-section" id="videoSection"></div>

                <!-- Current Set -->
                <div class="current-set">
                    <div class="set-number" id="setNumber">SERIE 1 de 4</div>
                    <div class="set-inputs">
                        <div class="input-group">
                            <label class="input-label">Peso (kg)</label>
                            <input type="number" class="set-input" id="weightInput" placeholder="0" min="0" step="0.5" inputmode="decimal">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Reps</label>
                            <input type="number" class="set-input" id="repsInput" placeholder="12" min="1" inputmode="numeric">
                        </div>
                    </div>
                    <button class="complete-set-btn" onclick="completeSet()">‚úì Completar Serie</button>
                    <button class="rest-config-btn" onclick="showRestTimeConfig()">‚öôÔ∏è Cambiar tiempo de reposo</button>

                    <!-- Rest Timer Inline -->
                    <div class="rest-timer-inline" id="restTimerInline">
                        <div class="timer-display" id="timerDisplay">01:30</div>
                        <div class="timer-bar">
                            <div class="timer-bar-fill" id="timerBarFill"></div>
                        </div>
                        <div class="timer-label">‚è±Ô∏è Tiempo de descanso</div>
                        <button class="skip-rest-btn" onclick="skipRest()">Saltar descanso</button>
                    </div>
                </div>

                <!-- Completed Sets -->
                <div class="completed-sets" id="completedSets">
                    <h3>Series Completadas</h3>
                    <div id="completedSetsList"></div>
                </div>

                <!-- Last Workout -->
                <div class="last-workout hidden" id="lastWorkout">
                    <h3>üìä √öltima vez:</h3>
                    <div class="last-workout-data" id="lastWorkoutData"></div>
                </div>

                <!-- Exercise Notes -->
                <div class="exercise-notes" id="exerciseNotes"></div>

                <!-- Tips -->
                <div class="tips">
                    <h3>üí° Consejos de T√©cnica</h3>
                    <p id="exerciseTips"></p>
                </div>
            </section>

            <!-- SUMMARY VIEW -->
            <section id="summaryView" class="summary-view">
                <div class="summary-icon">üéâ</div>
                <h2 class="summary-title">¬°Entrenamiento Completado!</h2>
                <p class="summary-subtitle" id="summaryDay"></p>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Volumen Total</div>
                        <div class="summary-stat-value" id="summaryVolume">0 kg</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Series Completadas</div>
                        <div class="summary-stat-value" id="summarySets">0 series</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Duraci√≥n</div>
                        <div class="summary-stat-value" id="summaryDuration">0 min</div>
                    </div>
                </div>
                <button class="back-to-home-btn" onclick="backToHome()">‚Üê Volver al Inicio</button>
            </section>

            <!-- PROGRESS VIEW -->
            <section id="progressView" class="hidden">
                <h2 class="workout-title">Historial</h2>
                <p class="workout-subtitle">Tu progreso de entrenamiento</p>
                <div id="progressContent"></div>
            </section>

            <!-- SETTINGS VIEW -->
            <section id="settingsView" class="hidden">
                <h2 class="workout-title">Ajustes</h2>

                <div class="settings-section">
                    <h3 class="settings-title">Meta Semanal</h3>
                    <div class="settings-item">
                        <span class="settings-item-label">Entrenamientos por semana</span>
                        <select id="weeklyGoalSelect" onchange="updateWeeklyGoal()" style="padding: 8px; border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6" selected>6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Datos</h3>
                    <div class="backup-section">
                        <h3>üíæ Backup de Datos</h3>
                        <div class="backup-buttons">
                            <button class="backup-btn export" onclick="exportBackup()">üì• Exportar</button>
                            <button class="backup-btn import" onclick="importBackup()">üì§ Importar</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showView('home')" data-view="home">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Inicio</span>
            </button>
            <button class="nav-item" onclick="showView('progress')" data-view="progress">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Progreso</span>
            </button>
            <button class="nav-item" onclick="showRoutineSelector()" data-view="workout">
                <span class="nav-icon">üí™</span>
                <span class="nav-label">Entrenar</span>
            </button>
            <button class="nav-item" onclick="showView('settings')" data-view="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Ajustes</span>
            </button>
        </nav>
    </div>

    <!-- Routine Selector Modal -->
    <div class="modal-overlay" id="routineModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3>¬øQu√© vas a entrenar hoy?</h3>
            </div>
            <div class="modal-body" id="routineOptions"></div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeRoutineModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Rest Time Config Modal -->
    <div class="modal-overlay" id="restTimeModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3>‚öôÔ∏è Tiempos de Descanso</h3>
            </div>
            <div class="modal-body" id="restTimeModalBody"></div>
            <div class="modal-footer" style="display: flex; gap: 12px;">
                <button class="modal-btn cancel" onclick="closeRestTimeModal()" style="flex: 1;">Cancelar</button>
                <button class="modal-btn" onclick="saveRestTimeConfig()" style="flex: 1; background: var(--accent-teal); color: white;">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. DATA MODEL - ROUTINE
        // ============================================

        const ROUTINE = {
            day1: {
                name: 'PECHO',
                fullName: 'D√çA 1 - PECHO',
                emoji: 'üí™',
                icon: 'üìà',
                exercises: [
                    { id: 'e1', name: 'Contractor de Pecho', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=contractor+pecho+gym', tips: 'Mant√©n los codos ligeramente flexionados y controla el movimiento.' },
                    { id: 'e2', name: 'Press de Banca con Mancuernas', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=press+banca+mancuernas', tips: 'Mant√©n los pies firmes en el suelo y la espalda pegada al banco.' },
                    { id: 'e3', name: 'Apertura en Banco Inclinado', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=apertura+banco+inclinado', tips: 'No bajes demasiado para evitar lesiones en el hombro.' },
                    { id: 'e4', name: 'Pullover', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=pullover+gym', tips: 'Estira bien el pecho en la fase exc√©ntrica.' }
                ]
            },
            day2: {
                name: 'PIERNAS',
                fullName: 'D√çA 2 - PIERNAS',
                emoji: 'ü¶µ',
                icon: 'üéØ',
                exercises: [
                    { id: 'e5', name: 'Extensi√≥n de Piernas', sets: 5, reps: 12, rest: 90, warmup: true, video: 'https://x.com/DSecretsOfLife/status/1972513225175437469', tips: 'Primera serie es calentamiento con peso ligero.' },
                    { id: 'e6', name: 'Prensa', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=prensa+piernas', tips: 'No bloquees las rodillas completamente en la extensi√≥n.' },
                    { id: 'e7', name: 'Sentadillas', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=sentadillas+t√©cnica', tips: 'Baja hasta que los muslos est√©n paralelos al suelo.' },
                    { id: 'e8', name: 'Hip Thrust', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=hip+thrust', tips: 'Aprieta los gl√∫teos en la parte superior del movimiento.' },
                    { id: 'e9', name: 'Femoral Tumbado', sets: 5, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=femoral+tumbado', tips: 'Controla el movimiento en ambas fases.' },
                    { id: 'e10', name: 'Aductor', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=aductor+m√°quina', tips: 'Movimiento controlado, no uses impulso.' },
                    { id: 'e11', name: 'Abductores', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=abductores+m√°quina', tips: 'Mant√©n la espalda recta durante el ejercicio.' }
                ]
            },
            day3: {
                name: 'ESPALDA',
                fullName: 'D√çA 3 - ESPALDA',
                emoji: 'üí™',
                icon: 'üìä',
                exercises: [
                    { id: 'e12', name: 'Jal√≥n al Pecho Agarre Ancho', sets: 4, reps: 12, rest: 60, warmup: true, video: 'https://www.youtube.com/results?search_query=jal√≥n+pecho+agarre+ancho', tips: 'Primera serie es calentamiento. Tira con los codos, no con las manos.' },
                    { id: 'e13', name: 'Remo Bajo en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=remo+bajo+polea', tips: 'Mant√©n la espalda recta y aprieta las esc√°pulas al final.' },
                    { id: 'e14', name: 'Remo en Banco con Mancuernas', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=remo+banco+mancuernas', tips: 'El codo debe subir m√°s alto que la espalda.' },
                    { id: 'e15', name: 'Pullover en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=pullover+polea+espalda', tips: 'Mant√©n los brazos ligeramente flexionados.' }
                ]
            },
            day4: {
                name: 'B√çCEPS Y HOMBRO',
                fullName: 'D√çA 4 - B√çCEPS Y HOMBRO',
                emoji: 'üí™',
                icon: 'üî•',
                exercises: [
                    { id: 'e16', name: 'La Vuelta al Mundo', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=vuelta+al+mundo+hombros', tips: 'Movimiento circular completo y controlado.' },
                    { id: 'e17', name: 'Elevaciones Laterales', sets: 3, reps: 15, rest: 60, video: 'https://www.youtube.com/results?search_query=elevaciones+laterales', tips: 'No subas m√°s arriba de los hombros.' },
                    { id: 'e18', name: 'Elevaciones Frontales', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=elevaciones+frontales', tips: 'Mant√©n el core activado para evitar balanceo.' },
                    { id: 'e19', name: 'Press de Hombro en M√°quina', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=press+hombro+m√°quina', tips: 'Empuja hacia arriba sin bloquear los codos.' },
                    { id: 'e20', name: 'P√°jaro M√°quina Peck Deck', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=p√°jaro+m√°quina', tips: 'Aprieta las esc√°pulas al final del movimiento.' },
                    { id: 'e21', name: 'Jal√≥n al Ment√≥n', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=jal√≥n+ment√≥n', tips: 'Los codos deben ir m√°s altos que las manos.' }
                ]
            },
            day5: {
                name: 'B√çCEPS Y TR√çCEPS',
                fullName: 'D√çA 5 - B√çCEPS Y TR√çCEPS',
                emoji: 'üí™',
                icon: '‚ö°',
                exercises: [
                    { id: 'e22', name: 'Curl de B√≠ceps con Mancuerna', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+b√≠ceps+mancuerna', tips: 'No balancees el cuerpo, solo mueve el antebrazo.' },
                    { id: 'e23', name: 'Curl de B√≠cep en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+b√≠ceps+polea', tips: 'Mant√©n los codos pegados al cuerpo.' },
                    { id: 'e24', name: 'Martillo', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+martillo', tips: 'Agarre neutral, como si sostuvieras un martillo.' },
                    { id: 'e25', name: 'Tr√≠ceps con Cuerda en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=tr√≠ceps+cuerda+polea', tips: 'Separa la cuerda al final del movimiento.' },
                    { id: 'e26', name: 'Trasnuca con Mancuerna', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=trasnuca+mancuerna+tr√≠ceps', tips: 'Mant√©n el codo apuntando hacia arriba.' },
                    { id: 'e27', name: 'Tr√≠ceps con Barra Z en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=tr√≠ceps+barra+z', tips: 'Codos pegados al cuerpo durante todo el movimiento.' }
                ]
            }
        };

        // ============================================
        // 2. STATE MANAGEMENT
        // ============================================

        let currentDay = null;
        let currentExerciseId = null;
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let workoutStartTime = null;
        let timerInterval = null;
        let workoutData = {};
        let exerciseNotes = {};
        let weeklyGoal = 6;
        let currentView = 'home';

        // ============================================
        // 3. DATA PERSISTENCE
        // ============================================

        function loadData() {
            // Load workout data
            const saved = localStorage.getItem('gymflow-data');
            if (saved) {
                try {
                    workoutData = JSON.parse(saved);
                    // Migrate old format if needed
                    migrateDataIfNeeded();
                } catch (e) {
                    console.error('Error loading workout data:', e);
                    workoutData = {};
                }
            }

            // Load exercise notes
            const notes = localStorage.getItem('gymflow-exercise-notes');
            if (notes) {
                try {
                    exerciseNotes = JSON.parse(notes);
                } catch (e) {
                    console.error('Error loading exercise notes:', e);
                    exerciseNotes = {};
                }
            }

            // Load weekly goal
            const goal = localStorage.getItem('gymflow-weekly-goal');
            if (goal) {
                weeklyGoal = parseInt(goal) || 6;
            }
        }

        function autoSave() {
            localStorage.setItem('gymflow-data', JSON.stringify(workoutData));
        }

        function saveExerciseNotes() {
            localStorage.setItem('gymflow-exercise-notes', JSON.stringify(exerciseNotes));
        }

        function migrateDataIfNeeded() {
            // Check if data is in old format (direct exercises object)
            // Old format: { "2025-01-01": { day: "day1", exercises: {...} } }
            // New format: { "2025-01-01": { workouts: [{...}] } }

            let needsMigration = false;
            const migratedData = {};

            for (const date in workoutData) {
                const dayData = workoutData[date];

                // Check if old format (has 'day' property but no 'workouts' array)
                if (dayData.day && !dayData.workouts) {
                    needsMigration = true;

                    // Migrate to new format
                    migratedData[date] = {
                        workouts: [{
                            id: 'w1',
                            routineType: dayData.day,
                            date: date,
                            exercises: dayData.exercises || {},
                            customRestTimes: dayData.customRestTimes || {}
                        }]
                    };
                } else {
                    migratedData[date] = dayData;
                }
            }

            if (needsMigration) {
                workoutData = migratedData;
                autoSave();
                console.log('‚úÖ Data migrated to new format');
            }
        }

        // ============================================
        // 4. INITIALIZATION
        // ============================================

        function init() {
            loadData();
            renderWeekCalendar();
            renderRecentWorkouts();
            renderMonthlyProgress();
            updateWeeklyGoalDisplay();
            updateBestStreak();

            // Set weekly goal select
            const goalSelect = document.getElementById('weeklyGoalSelect');
            if (goalSelect) {
                goalSelect.value = weeklyGoal;
            }
        }

        // ============================================
        // 5. VIEW NAVIGATION
        // ============================================

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.main-content > section').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById('exerciseView').classList.remove('active');

            // Show selected view
            const viewId = viewName + 'View';
            const view = document.getElementById(viewId);
            if (view) {
                view.classList.remove('hidden');
                if (viewName === 'exercise') {
                    view.classList.add('active');
                }
            }

            // Update bottom nav
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.view === viewName) {
                    n.classList.add('active');
                }
            });

            currentView = viewName;

            // Render view-specific content
            if (viewName === 'home') {
                renderWeekCalendar();
                renderRecentWorkouts();
                renderMonthlyProgress();
                updateWeeklyGoalDisplay();
            } else if (viewName === 'progress') {
                renderProgressView();
            }
        }

        // ============================================
        // 6. WEEK CALENDAR
        // ============================================

        function getWeekDays() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            const days = [];
            const dayLetters = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateKey = date.toISOString().split('T')[0];

                days.push({
                    letter: dayLetters[i],
                    number: date.getDate(),
                    dateKey: dateKey,
                    isToday: dateKey === getTodayKey(),
                    hasWorkout: hasWorkoutOnDate(dateKey)
                });
            }

            return days;
        }

        function hasWorkoutOnDate(dateKey) {
            const dayData = workoutData[dateKey];
            if (!dayData) return false;

            if (dayData.workouts && dayData.workouts.length > 0) {
                return dayData.workouts.some(w =>
                    w.exercises && Object.keys(w.exercises).length > 0
                );
            }

            return false;
        }

        function renderWeekCalendar() {
            const container = document.getElementById('weekDays');
            const days = getWeekDays();

            const completedCount = days.filter(d => d.hasWorkout).length;
            document.getElementById('weekProgress').textContent = `${completedCount} de ${weeklyGoal}`;

            container.innerHTML = days.map(day => `
                <div class="day-cell ${day.isToday ? 'today' : ''} ${day.hasWorkout ? 'completed' : ''}"
                     onclick="showDayWorkouts('${day.dateKey}')">
                    <span class="day-letter">${day.letter}</span>
                    <span class="day-number">${day.hasWorkout ? '‚úì' : day.number}</span>
                </div>
            `).join('');
        }

        function showDayWorkouts(dateKey) {
            // TODO: Show workouts for specific day
            console.log('Show workouts for:', dateKey);
        }

        // ============================================
        // 7. WEEKLY GOAL & STREAK
        // ============================================

        function updateWeeklyGoalDisplay() {
            const days = getWeekDays();
            const completedCount = days.filter(d => d.hasWorkout).length;
            document.getElementById('weeklyGoalCount').textContent = `${completedCount}/${weeklyGoal}`;
        }

        function updateWeeklyGoal() {
            const select = document.getElementById('weeklyGoalSelect');
            weeklyGoal = parseInt(select.value) || 6;
            localStorage.setItem('gymflow-weekly-goal', weeklyGoal);
            updateWeeklyGoalDisplay();
            renderWeekCalendar();
        }

        function editWeeklyGoal() {
            showView('settings');
        }

        function updateBestStreak() {
            const streak = calculateBestStreak();
            document.getElementById('bestStreakValue').textContent = `${streak} sem`;
        }

        function calculateBestStreak() {
            // Calculate longest streak of consecutive weeks with at least weeklyGoal workouts
            const sortedDates = Object.keys(workoutData).sort();
            if (sortedDates.length === 0) return 0;

            let bestStreak = 0;
            let currentStreak = 0;
            let lastWeek = null;

            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const weekNum = getWeekNumber(date);

                if (lastWeek === null || weekNum === lastWeek + 1) {
                    currentStreak++;
                } else if (weekNum !== lastWeek) {
                    currentStreak = 1;
                }

                bestStreak = Math.max(bestStreak, currentStreak);
                lastWeek = weekNum;
            });

            return bestStreak;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // ============================================
        // 8. RECENT WORKOUTS
        // ============================================

        function renderRecentWorkouts() {
            const container = document.getElementById('recentWorkouts');
            const recentWorkouts = getRecentWorkouts(10);

            if (recentWorkouts.length === 0) {
                container.innerHTML = '<div class="no-workouts">No hay entrenamientos recientes</div>';
                return;
            }

            container.innerHTML = recentWorkouts.map(workout => {
                const routine = ROUTINE[workout.routineType];
                const exerciseNames = Object.keys(workout.exercises)
                    .slice(0, 3)
                    .map(exId => {
                        const ex = routine?.exercises.find(e => e.id === exId);
                        return ex ? ex.name.split(' ')[0] : '';
                    })
                    .filter(Boolean)
                    .join(' ¬∑ ');

                return `
                    <div class="workout-card" onclick="viewWorkoutDetails('${workout.date}', '${workout.id}')">
                        <div class="workout-icon">${routine?.icon || 'üí™'}</div>
                        <h3>${routine?.name || 'Entrenamiento'}</h3>
                        <span class="workout-date">${formatRelativeDate(workout.date)}</span>
                        <p class="workout-exercises">${exerciseNames || 'Sin ejercicios'}</p>
                    </div>
                `;
            }).join('');
        }

        function getRecentWorkouts(limit) {
            const workouts = [];
            const sortedDates = Object.keys(workoutData).sort().reverse();

            for (const date of sortedDates) {
                const dayData = workoutData[date];

                if (dayData.workouts) {
                    dayData.workouts.forEach(w => {
                        if (w.exercises && Object.keys(w.exercises).length > 0) {
                            workouts.push({
                                ...w,
                                date: date
                            });
                        }
                    });
                }

                if (workouts.length >= limit) break;
            }

            return workouts.slice(0, limit);
        }

        function formatRelativeDate(dateStr) {
            const today = getTodayKey();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];

            if (dateStr === today) return 'Hoy';
            if (dateStr === yesterdayKey) return 'Ayer';

            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short' };
            return date.toLocaleDateString('es-ES', options);
        }

        function viewWorkoutDetails(date, workoutId) {
            // TODO: Implement workout details view
            console.log('View workout:', date, workoutId);
        }

        // ============================================
        // 9. MONTHLY PROGRESS
        // ============================================

        function renderMonthlyProgress() {
            const container = document.getElementById('monthlyProgress');
            const months = getLastMonths(6);

            container.innerHTML = months.map(month => {
                const stats = getMonthStats(month.year, month.month);
                const percentage = Math.min(100, (stats.workouts / 20) * 100);
                const isCurrent = month.isCurrent;

                return `
                    <div class="month-card ${isCurrent ? 'current' : ''}">
                        <div class="month-icon">${month.icon}</div>
                        <div class="month-name">${month.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isCurrent ? 'coral' : 'green'}"
                                 style="width: ${percentage}%"></div>
                        </div>
                        <div class="workout-count">
                            ${stats.workouts > 0
                                ? `<strong>${stats.workouts}</strong> entrenos`
                                : isCurrent ? 'En curso' : 'Sin datos'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLastMonths(count) {
            const months = [];
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthIcons = ['‚≠ê', '‚ùÑÔ∏è', 'üå∏', 'üå±', 'üå∫', '‚òÄÔ∏è', 'üå¥', 'üî•', 'üçÇ', 'üéÉ', 'üçÅ', 'üéÑ'];

            const today = new Date();

            for (let i = 0; i < count; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                months.push({
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    name: monthNames[date.getMonth()],
                    icon: monthIcons[date.getMonth()],
                    isCurrent: i === 0
                });
            }

            return months;
        }

        function getMonthStats(year, month) {
            let workouts = 0;

            for (const date in workoutData) {
                const d = new Date(date);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    const dayData = workoutData[date];
                    if (dayData.workouts) {
                        workouts += dayData.workouts.filter(w =>
                            w.exercises && Object.keys(w.exercises).length > 0
                        ).length;
                    }
                }
            }

            return { workouts };
        }

        // ============================================
        // 10. ROUTINE SELECTOR
        // ============================================

        function showRoutineSelector() {
            const container = document.getElementById('routineOptions');

            container.innerHTML = Object.entries(ROUTINE).map(([dayKey, routine]) => `
                <div class="routine-option" onclick="startWorkout('${dayKey}')">
                    <span class="routine-emoji">${routine.emoji}</span>
                    <div class="routine-info">
                        <h4>${routine.name}</h4>
                        <p>${routine.exercises.length} ejercicios</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('routineModal').classList.add('active');
        }

        function closeRoutineModal() {
            document.getElementById('routineModal').classList.remove('active');
        }

        // ============================================
        // 11. WORKOUT VIEW
        // ============================================

        function startWorkout(dayKey) {
            closeRoutineModal();
            currentDay = dayKey;
            workoutStartTime = Date.now();

            // Initialize today's workout data if needed
            const todayKey = getTodayKey();
            if (!workoutData[todayKey]) {
                workoutData[todayKey] = { workouts: [] };
            }

            // Create new workout entry
            const workoutId = 'w' + Date.now();
            workoutData[todayKey].workouts.push({
                id: workoutId,
                routineType: dayKey,
                startTime: new Date().toISOString(),
                exercises: {}
            });
            autoSave();

            loadWorkoutView();
            showView('workout');
        }

        function loadWorkoutView() {
            const dayData = ROUTINE[currentDay];
            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1] || { exercises: {} };

            document.getElementById('workoutTitle').textContent = dayData.fullName;

            const totalSets = dayData.exercises.reduce((sum, ex) => sum + ex.sets, 0);
            document.getElementById('workoutSubtitle').textContent =
                `${dayData.exercises.length} ejercicios ‚Ä¢ ${totalSets} series`;

            const exerciseListHtml = dayData.exercises.map((exercise, index) => {
                const exerciseData = currentWorkout.exercises[exercise.id] || { sets: [] };
                const completedSets = exerciseData.sets?.length || 0;
                const isCompleted = completedSets >= exercise.sets;
                const isActive = currentExerciseId === exercise.id;

                let status = '‚ö™';
                if (isCompleted) status = '‚úÖ';
                else if (isActive) status = '‚ñ∂Ô∏è';

                let lastWorkout = '';
                if (completedSets > 0) {
                    const lastSet = exerciseData.sets[completedSets - 1];
                    lastWorkout = `<div class="exercise-last">√öltima: ${lastSet.weight}kg √ó ${lastSet.reps} reps</div>`;
                }

                return `
                    <div class="exercise-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}"
                         onclick="startExercise('${exercise.id}', ${index})">
                        <div class="exercise-status">${status}</div>
                        <div class="exercise-info">
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-details">
                                ${completedSets}/${exercise.sets} series ‚Ä¢ ${exercise.reps} reps
                                ${exercise.warmup ? ' ‚Ä¢ üî• Calentamiento' : ''}
                            </div>
                            ${lastWorkout}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('exerciseList').innerHTML = exerciseListHtml;
        }

        function cancelWorkout() {
            if (confirm('¬øSeguro que quieres cancelar el entrenamiento?')) {
                currentDay = null;
                currentExerciseId = null;
                workoutStartTime = null;
                showView('home');
            }
        }

        // ============================================
        // 12. EXERCISE VIEW
        // ============================================

        function startExercise(exerciseId, index) {
            currentExerciseId = exerciseId;
            currentExerciseIndex = index;

            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === exerciseId);
            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1] || { exercises: {} };
            const exerciseData = currentWorkout.exercises[exerciseId] || { sets: [] };

            currentSetNumber = (exerciseData.sets?.length || 0) + 1;

            if (currentSetNumber > exercise.sets) {
                currentSetNumber = exercise.sets;
            }

            // Update UI
            document.getElementById('exerciseName').textContent = exercise.name;
            document.getElementById('exerciseProgress').textContent =
                `Ejercicio ${index + 1} de ${dayData.exercises.length}`;
            document.getElementById('exerciseTips').textContent = exercise.tips;
            document.getElementById('setNumber').textContent =
                `SERIE ${currentSetNumber} de ${exercise.sets}`;

            // Render video section
            renderVideoSection(exercise.video);

            // Show last workout reference
            const lastWorkoutEl = document.getElementById('lastWorkout');
            const lastWorkoutData = getLastWorkoutForExercise(exerciseId);
            if (lastWorkoutData) {
                lastWorkoutEl.classList.remove('hidden');
                const daysAgo = Math.floor((Date.now() - new Date(lastWorkoutData.date).getTime()) / (1000 * 60 * 60 * 24));
                const avgWeight = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.weight, 0) / lastWorkoutData.sets.length);
                const avgReps = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.reps, 0) / lastWorkoutData.sets.length);
                document.getElementById('lastWorkoutData').textContent =
                    `${avgWeight}kg √ó ${avgReps} reps (hace ${daysAgo} d√≠as)`;
            } else {
                lastWorkoutEl.classList.add('hidden');
            }

            // Auto-fill inputs
            if (exerciseData.sets && exerciseData.sets.length > 0) {
                const lastSet = exerciseData.sets[exerciseData.sets.length - 1];
                document.getElementById('weightInput').value = lastSet.weight;
                document.getElementById('repsInput').value = lastSet.reps;
            } else if (lastWorkoutData) {
                const avgWeight = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.weight, 0) / lastWorkoutData.sets.length);
                const avgReps = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.reps, 0) / lastWorkoutData.sets.length);
                document.getElementById('weightInput').value = avgWeight;
                document.getElementById('repsInput').value = avgReps;
            } else {
                document.getElementById('weightInput').value = '';
                document.getElementById('repsInput').value = exercise.reps;
            }

            // Render completed sets
            renderCompletedSets(exerciseData.sets || []);

            // Render exercise note
            renderExerciseNote(exerciseId);

            // Hide rest timer
            document.getElementById('restTimerInline').classList.remove('active');

            showView('exercise');
        }

        function renderCompletedSets(sets) {
            const container = document.getElementById('completedSetsList');
            if (!sets || sets.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 14px;">No hay series completadas a√∫n</p>';
                return;
            }

            let html = sets.map((set, index) => `
                <div class="completed-set">
                    <span class="set-label">Serie ${index + 1}</span>
                    <span class="set-data">${set.weight}kg √ó ${set.reps} reps</span>
                    <span class="set-time">${new Date(set.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
            `).join('');

            html += '<button class="delete-last-set-btn" onclick="deleteLastSet()">üóëÔ∏è Borrar √∫ltima serie</button>';
            container.innerHTML = html;
        }

        function renderVideoSection(videoUrl) {
            const container = document.getElementById('videoSection');
            const isTwitter = videoUrl.includes('twitter.com') || videoUrl.includes('x.com');
            const isYouTube = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be');

            if (isTwitter) {
                const tweetId = extractTweetId(videoUrl);
                if (tweetId) {
                    container.innerHTML = `
                        <div class="video-embed-container" id="twitterEmbed-${tweetId}">
                            <div style="color: var(--text-muted); font-size: 14px;">Cargando video...</div>
                        </div>
                        <a class="video-link twitter" href="${videoUrl}" target="_blank">üê¶ Ver en X/Twitter</a>
                    `;
                    loadTwitterEmbed(tweetId);
                } else {
                    container.innerHTML = `
                        <div class="placeholder">üé•</div>
                        <a class="video-link twitter" href="${videoUrl}" target="_blank">üê¶ Ver en X/Twitter</a>
                    `;
                }
            } else {
                container.innerHTML = `
                    <div class="placeholder">üé•</div>
                    <a class="video-link" href="${videoUrl}" target="_blank">üì∫ Ver T√©cnica en YouTube</a>
                `;
            }
        }

        function extractTweetId(url) {
            const patterns = [/status\/(\d+)/, /\/(\d+)(?:\?|$)/];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) return match[1];
            }
            return null;
        }

        function loadTwitterEmbed(tweetId) {
            if (typeof twttr === 'undefined') {
                setTimeout(() => loadTwitterEmbed(tweetId), 500);
                return;
            }

            const container = document.getElementById(`twitterEmbed-${tweetId}`);
            if (!container) return;

            container.innerHTML = '';
            twttr.widgets.createTweet(tweetId, container, {
                theme: 'dark',
                cards: 'visible',
                conversation: 'none',
                align: 'center',
                width: 550
            }).then((el) => {
                if (!el) {
                    container.innerHTML = '<div style="color: var(--danger); font-size: 14px;">Error al cargar el video</div>';
                }
            });
        }

        function completeSet() {
            const weight = parseFloat(document.getElementById('weightInput').value);
            const reps = parseInt(document.getElementById('repsInput').value);

            if (!weight || weight <= 0 || !reps || reps <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa peso y reps v√°lidos');
                return;
            }

            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            const todayKey = getTodayKey();

            // Get current workout
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1];

            if (!currentWorkout.exercises[currentExerciseId]) {
                currentWorkout.exercises[currentExerciseId] = { sets: [] };
            }

            // Add set
            currentWorkout.exercises[currentExerciseId].sets.push({
                weight,
                reps,
                timestamp: new Date().toISOString()
            });

            autoSave();

            // Update UI
            currentSetNumber++;
            const exerciseData = currentWorkout.exercises[currentExerciseId];

            if (currentSetNumber <= exercise.sets) {
                document.getElementById('setNumber').textContent =
                    `SERIE ${currentSetNumber} de ${exercise.sets}`;
                renderCompletedSets(exerciseData.sets);

                // Start rest timer
                const customRestTimes = exerciseData.customRestTimes || [];
                const previousSetIndex = currentSetNumber - 2;
                const restTime = customRestTimes[previousSetIndex] || exercise.rest;
                startRestTimer(restTime);
            } else {
                renderCompletedSets(exerciseData.sets);
                setTimeout(() => {
                    alert('‚úÖ ¬°Ejercicio completado!');
                    backToWorkout();
                }, 500);
            }
        }

        function deleteLastSet() {
            if (!confirm('¬øSeguro que quieres borrar la √∫ltima serie?')) return;

            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1];
            const exerciseData = currentWorkout?.exercises[currentExerciseId];

            if (!exerciseData || !exerciseData.sets || exerciseData.sets.length === 0) {
                alert('‚ö†Ô∏è No hay series para borrar');
                return;
            }

            exerciseData.sets.pop();
            currentSetNumber = exerciseData.sets.length + 1;
            autoSave();
            stopRestTimer();

            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            document.getElementById('setNumber').textContent =
                `SERIE ${currentSetNumber} de ${exercise.sets}`;
            renderCompletedSets(exerciseData.sets);
        }

        function backToWorkout() {
            currentExerciseId = null;
            loadWorkoutView();
            showView('workout');
            stopRestTimer();
        }

        // ============================================
        // 13. REST TIMER
        // ============================================

        function startRestTimer(seconds) {
            stopRestTimer();

            const timerDisplay = document.getElementById('timerDisplay');
            const timerBarFill = document.getElementById('timerBarFill');
            const restTimerInline = document.getElementById('restTimerInline');

            restTimerInline.classList.add('active');

            const startTime = Date.now();
            const endTime = startTime + (seconds * 1000);
            const totalDuration = seconds * 1000;

            function updateTimer() {
                const now = Date.now();
                const remainingMs = Math.max(0, endTime - now);
                const remaining = Math.ceil(remainingMs / 1000);

                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                const elapsed = now - startTime;
                const percentage = Math.min(100, (elapsed / totalDuration) * 100);
                timerBarFill.style.width = percentage + '%';

                if (remainingMs <= 0) {
                    stopRestTimer();
                    restTimerInline.classList.remove('active');

                    // Vibration
                    try {
                        if ('vibrate' in navigator) {
                            navigator.vibrate([400, 200, 400, 200, 600]);
                        }
                    } catch (e) { }

                    // Visual Flash
                    try {
                        const flash = document.createElement('div');
                        flash.className = 'timer-flash-overlay';
                        document.body.appendChild(flash);
                        setTimeout(() => flash.remove(), 1000);
                    } catch (e) { }

                    // Audio Beep
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) { }

                    // Notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('‚è∞ Descanso terminado', {
                            body: '¬°Listo para la siguiente serie!',
                            icon: '/gymrat/icons/icon-192.png'
                        });
                    }
                }
            }

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopRestTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('restTimerInline').classList.remove('active');
        }

        function skipRest() {
            stopRestTimer();
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ============================================
        // 14. REST TIME CONFIG
        // ============================================

        function showRestTimeConfig() {
            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            if (!exercise) return;

            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1];
            const exerciseData = currentWorkout?.exercises[currentExerciseId] || { sets: [] };
            const customRestTimes = exerciseData.customRestTimes || [];
            const defaultRest = exercise.rest;

            let modalContent = '<p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px;">Configura el tiempo de descanso para cada serie (en segundos).</p>';

            for (let i = 0; i < exercise.sets; i++) {
                const restTime = customRestTimes[i] || defaultRest;
                modalContent += `
                    <div class="rest-config-item">
                        <span class="rest-config-label">Serie ${i + 1}</span>
                        <input type="number" class="rest-config-input" id="restTime-${i}" value="${restTime}" min="0" max="600" step="5" />
                        <span style="margin-left: 8px; color: var(--text-muted); font-size: 14px;">seg</span>
                    </div>
                `;
            }

            document.getElementById('restTimeModalBody').innerHTML = modalContent;
            document.getElementById('restTimeModal').classList.add('active');
        }

        function closeRestTimeModal() {
            document.getElementById('restTimeModal').classList.remove('active');
        }

        function saveRestTimeConfig() {
            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            if (!exercise) return;

            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1];

            if (!currentWorkout.exercises[currentExerciseId]) {
                currentWorkout.exercises[currentExerciseId] = { sets: [] };
            }

            const customRestTimes = [];
            for (let i = 0; i < exercise.sets; i++) {
                const input = document.getElementById(`restTime-${i}`);
                const restTime = parseInt(input.value) || exercise.rest;
                customRestTimes.push(restTime);
            }

            currentWorkout.exercises[currentExerciseId].customRestTimes = customRestTimes;
            autoSave();
            closeRestTimeModal();
            alert('‚úÖ Tiempos de descanso configurados');
        }

        // ============================================
        // 15. WORKOUT SUMMARY
        // ============================================

        function finishWorkout() {
            const todayKey = getTodayKey();
            const todayWorkouts = workoutData[todayKey]?.workouts || [];
            const currentWorkout = todayWorkouts[todayWorkouts.length - 1];

            if (!currentWorkout || Object.keys(currentWorkout.exercises).length === 0) {
                alert('‚ö†Ô∏è No has completado ning√∫n ejercicio a√∫n');
                return;
            }

            // Calculate stats
            let totalVolume = 0;
            let totalSets = 0;

            Object.values(currentWorkout.exercises).forEach(exerciseData => {
                if (exerciseData.sets) {
                    exerciseData.sets.forEach(set => {
                        totalVolume += set.weight * set.reps;
                        totalSets++;
                    });
                }
            });

            const durationMinutes = workoutStartTime ?
                Math.round((Date.now() - workoutStartTime) / (1000 * 60)) : 0;

            // Save end time
            currentWorkout.endTime = new Date().toISOString();
            autoSave();

            // Update UI
            const dayData = ROUTINE[currentDay];
            document.getElementById('summaryDay').textContent = dayData.fullName;
            document.getElementById('summaryVolume').textContent = totalVolume.toLocaleString('es-ES') + ' kg';
            document.getElementById('summarySets').textContent = totalSets + ' series';
            document.getElementById('summaryDuration').textContent = durationMinutes + ' min';

            currentDay = null;
            currentExerciseId = null;
            workoutStartTime = null;

            showView('summary');
        }

        function backToHome() {
            showView('home');
        }

        // ============================================
        // 16. PROGRESS VIEW
        // ============================================

        function renderProgressView() {
            const container = document.getElementById('progressContent');
            const sortedDates = Object.keys(workoutData).sort().reverse();

            if (sortedDates.length === 0) {
                container.innerHTML = '<div class="no-workouts">No hay entrenamientos registrados</div>';
                return;
            }

            let html = '';
            sortedDates.forEach(date => {
                const dayData = workoutData[date];
                if (dayData.workouts) {
                    dayData.workouts.forEach(workout => {
                        if (workout.exercises && Object.keys(workout.exercises).length > 0) {
                            const routine = ROUTINE[workout.routineType];
                            let totalVolume = 0;
                            let totalSets = 0;

                            Object.values(workout.exercises).forEach(ex => {
                                if (ex.sets) {
                                    ex.sets.forEach(s => {
                                        totalVolume += s.weight * s.reps;
                                        totalSets++;
                                    });
                                }
                            });

                            html += `
                                <div class="workout-card" style="flex: none; width: 100%; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div class="workout-icon" style="display: inline; margin-right: 8px;">${routine?.icon || 'üí™'}</div>
                                            <h3 style="display: inline;">${routine?.name || 'Entrenamiento'}</h3>
                                        </div>
                                        <span class="workout-date">${formatRelativeDate(date)}</span>
                                    </div>
                                    <p class="workout-exercises" style="margin-top: 8px;">
                                        ${totalSets} series ‚Ä¢ ${totalVolume.toLocaleString('es-ES')} kg volumen
                                    </p>
                                </div>
                            `;
                        }
                    });
                }
            });

            container.innerHTML = html || '<div class="no-workouts">No hay entrenamientos registrados</div>';
        }

        // ============================================
        // 17. EXERCISE NOTES
        // ============================================

        let saveNoteTimeout = null;

        function renderExerciseNote(exerciseId) {
            const container = document.getElementById('exerciseNotes');
            const note = exerciseNotes[exerciseId] || '';
            const hasNote = note.trim().length > 0;

            if (hasNote) {
                container.innerHTML = `
                    <div class="exercise-note-box">
                        <div class="exercise-note-header">
                            <h3>üìù Mis Notas</h3>
                            <button class="exercise-note-edit-btn" onclick="toggleEditNote('${exerciseId}')">‚úèÔ∏è</button>
                        </div>
                        <div class="exercise-note-text" id="noteText-${exerciseId}">${note}</div>
                        <textarea class="exercise-note-textarea hidden" id="noteTextarea-${exerciseId}"
                            placeholder="Ej: Sent√≠ buena activaci√≥n | Pr√≥xima semana 25kg"
                            maxlength="500" oninput="onNoteInput('${exerciseId}')">${note}</textarea>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <button class="exercise-note-add-btn" onclick="showNoteEditor('${exerciseId}')">
                        + A√±adir nota
                    </button>
                `;
            }
        }

        function toggleEditNote(exerciseId) {
            const textDiv = document.getElementById(`noteText-${exerciseId}`);
            const textarea = document.getElementById(`noteTextarea-${exerciseId}`);

            if (textarea.classList.contains('hidden')) {
                textDiv.classList.add('hidden');
                textarea.classList.remove('hidden');
                textarea.focus();
            } else {
                textDiv.classList.remove('hidden');
                textarea.classList.add('hidden');
                textDiv.textContent = textarea.value;
            }
        }

        function showNoteEditor(exerciseId) {
            const container = document.getElementById('exerciseNotes');
            container.innerHTML = `
                <div class="exercise-note-box">
                    <div class="exercise-note-header">
                        <h3>üìù Mis Notas</h3>
                    </div>
                    <textarea class="exercise-note-textarea" id="noteTextarea-${exerciseId}"
                        placeholder="Ej: Sent√≠ buena activaci√≥n | Pr√≥xima semana 25kg"
                        maxlength="500" oninput="onNoteInput('${exerciseId}')" autofocus></textarea>
                </div>
            `;
            setTimeout(() => document.getElementById(`noteTextarea-${exerciseId}`).focus(), 100);
        }

        function onNoteInput(exerciseId) {
            const textarea = document.getElementById(`noteTextarea-${exerciseId}`);
            const noteText = textarea.value.trim();

            if (saveNoteTimeout) clearTimeout(saveNoteTimeout);

            saveNoteTimeout = setTimeout(() => {
                if (noteText.length > 0) {
                    exerciseNotes[exerciseId] = noteText;
                } else {
                    delete exerciseNotes[exerciseId];
                }
                saveExerciseNotes();
            }, 500);
        }

        // ============================================
        // 18. UTILITY FUNCTIONS
        // ============================================

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function getLastWorkoutForExercise(exerciseId) {
            const todayKey = getTodayKey();
            const sortedDates = Object.keys(workoutData)
                .filter(date => date !== todayKey)
                .sort()
                .reverse();

            for (const date of sortedDates) {
                const dayData = workoutData[date];
                if (dayData.workouts) {
                    for (const workout of dayData.workouts) {
                        if (workout.exercises[exerciseId]?.sets?.length > 0) {
                            return {
                                date,
                                sets: workout.exercises[exerciseId].sets
                            };
                        }
                    }
                }
            }

            return null;
        }

        // ============================================
        // 19. BACKUP / RESTORE
        // ============================================

        function exportBackup() {
            const data = {
                workoutData,
                exerciseNotes,
                weeklyGoal,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gymflow-backup-${getTodayKey()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Backup exportado correctamente');
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        if (!data.workoutData && !data.exerciseNotes) {
                            alert('‚ùå Archivo de backup no v√°lido');
                            return;
                        }

                        if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de importar este backup?\n\nEsto SOBRESCRIBIR√Å todos tus datos actuales.')) {
                            return;
                        }

                        if (data.workoutData) {
                            workoutData = data.workoutData;
                            localStorage.setItem('gymflow-data', JSON.stringify(workoutData));
                        }

                        if (data.exerciseNotes) {
                            exerciseNotes = data.exerciseNotes;
                            localStorage.setItem('gymflow-exercise-notes', JSON.stringify(exerciseNotes));
                        }

                        if (data.weeklyGoal) {
                            weeklyGoal = data.weeklyGoal;
                            localStorage.setItem('gymflow-weekly-goal', weeklyGoal);
                        }

                        alert('‚úÖ Backup importado correctamente. La p√°gina se recargar√°.');
                        setTimeout(() => window.location.reload(), 1000);

                    } catch (error) {
                        console.error('Error importing backup:', error);
                        alert('‚ùå Error al importar el backup');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================
        // 20. INIT APP
        // ============================================

        init();

        // Prevent accidental page refresh
        window.addEventListener('beforeunload', (e) => {
            if (currentExerciseId || currentDay) {
                e.preventDefault();
                e.returnValue = 'Tienes un entreno en progreso. ¬øSeguro que quieres salir?';
            }
        });

        console.log('üöÄ GymFlow v2.0 iniciado correctamente');
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gymrat/service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>

</html>
