<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí™ GymFlow - Tu Entrenamiento Personal</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Tracking de entrenamientos de gimnasio - Tu rutina de 5 d√≠as">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GymFlow">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Twitter Embed SDK -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 100px;
            /* Space for timer */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .header .date {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Day Selector */
        .day-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 20px;
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
        }

        .day-btn {
            padding: 16px 8px;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.3;
        }

        .day-btn:active {
            transform: scale(0.95);
        }

        .day-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .day-btn .emoji {
            display: block;
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Workout View */
        .workout-view {
            padding: 24px;
        }

        .workout-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .workout-subtitle {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 24px;
        }

        /* Exercise List */
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .exercise-item {
            padding: 16px;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .exercise-item:active {
            transform: scale(0.98);
        }

        .exercise-item.completed {
            background: #d1fae5;
            border-color: var(--success);
        }

        .exercise-item.active {
            background: #e0e7ff;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .exercise-status {
            font-size: 24px;
            flex-shrink: 0;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 13px;
            color: var(--gray-600);
        }

        .exercise-last {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
            font-style: italic;
        }

        /* Exercise Detail View */
        .exercise-view {
            display: none;
            padding: 24px;
        }

        .exercise-view.active {
            display: block;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .back-btn {
            background: var(--gray-100);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-700);
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .exercise-header-info {
            flex: 1;
        }

        .exercise-header-info h2 {
            font-size: 20px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .exercise-header-info .progress {
            font-size: 13px;
            color: var(--gray-600);
        }

        /* Video Section */
        .video-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .video-section .placeholder {
            background: var(--gray-200);
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 12px;
        }

        .video-embed-container {
            width: 100%;
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--gray-200);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-link {
            display: inline-block;
            padding: 10px 20px;
            background: #ff0000;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .video-link.twitter {
            background: #1DA1F2;
        }

        /* Current Set */
        .current-set {
            background: var(--gray-50);
            border: 3px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .set-number {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .set-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--gray-600);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .set-input {
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 800;
            text-align: center;
            background: white;
            /* CR√çTICO: Prevenir zoom en iOS */
            font-size: 16px;
            min-height: 56px;
        }

        .set-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .complete-set-btn {
            width: 100%;
            padding: 18px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .complete-set-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .complete-set-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Rest Timer in Set */
        .rest-timer-inline {
            display: none;
            margin-top: 16px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            text-align: center;
            overflow: hidden;
        }

        .rest-timer-inline.active {
            display: block;
        }

        .rest-timer-inline .timer-display {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .rest-timer-inline .timer-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .rest-timer-inline .timer-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 1s linear;
        }

        .rest-timer-inline .timer-label {
            font-size: 13px;
            color: var(--gray-600);
        }

        /* Completed Sets */
        .completed-sets {
            margin-bottom: 24px;
        }

        .completed-sets h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-600);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .completed-set {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .completed-set .set-label {
            font-weight: 700;
            color: var(--success);
        }

        .completed-set .set-data {
            font-weight: 600;
            color: var(--gray-900);
        }

        .completed-set .set-time {
            font-size: 12px;
            color: var(--gray-600);
        }

        /* Last Workout */
        .last-workout {
            background: #fef3c7;
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .last-workout h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .last-workout-data {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Exercise Notes */
        .exercise-notes {
            margin-bottom: 24px;
        }

        .exercise-note-box {
            background: #e0f2fe;
            border: 2px solid #0284c7;
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .exercise-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .exercise-note-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .exercise-note-edit-btn {
            background: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .exercise-note-edit-btn:hover {
            opacity: 1;
        }

        .exercise-note-text {
            font-size: 14px;
            color: var(--gray-900);
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .exercise-note-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 200px;
            padding: 12px;
            border: 2px solid #0284c7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            background: white;
        }

        .exercise-note-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .exercise-note-add-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px dashed #0284c7;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #0284c7;
            cursor: pointer;
            transition: all 0.2s;
        }

        .exercise-note-add-btn:hover {
            background: #e0f2fe;
        }

        .exercise-note-add-btn:active {
            transform: scale(0.98);
        }

        /* Tips */
        .tips {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .tips h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .tips p {
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.5;
        }

        /* Finish Workout Button */
        .finish-workout-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .finish-workout-btn:active {
            transform: scale(0.98);
        }

        /* Floating Rest Timer */
        .floating-timer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            z-index: 1000;
        }

        .floating-timer.active {
            display: flex;
        }

        .floating-timer:active {
            transform: scale(0.95);
        }

        /* Summary View */
        .summary-view {
            display: none;
            padding: 24px;
            text-align: center;
        }

        .summary-view.active {
            display: block;
        }

        .summary-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .summary-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .summary-subtitle {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 32px;
        }

        .summary-stats {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary-stat {
            margin-bottom: 16px;
        }

        .summary-stat:last-child {
            margin-bottom: 0;
        }

        .summary-stat-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .summary-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .back-to-home-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
        }

        /* Backup Section */
        .backup-section {
            margin-top: 32px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 2px dashed var(--gray-300);
        }

        .backup-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 12px;
            text-align: center;
        }

        .backup-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .backup-btn {
            padding: 14px;
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .backup-btn:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .backup-btn:active {
            transform: scale(0.98);
        }

        .backup-btn.export {
            color: var(--success);
            border-color: var(--success);
        }

        .backup-btn.import {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px 16px 0 0;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 2px solid var(--gray-200);
            display: flex;
            gap: 12px;
        }

        /* Rest Time Config */
        .rest-config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid var(--gray-200);
        }

        .rest-config-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .rest-config-input {
            width: 100px;
            padding: 10px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            background: white;
        }

        .rest-config-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .rest-config-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .rest-config-btn:hover {
            background: var(--gray-50);
        }

        .rest-config-btn:active {
            transform: scale(0.98);
        }

        /* Modal Buttons */
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .modal-btn.cancel:active {
            background: var(--gray-300);
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn.primary:active {
            transform: scale(0.98);
        }

        /* Delete Last Set Button */
        .delete-last-set-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid var(--danger);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--danger);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .delete-last-set-btn:hover {
            background: #fee;
        }

        .delete-last-set-btn:active {
            transform: scale(0.98);
        }

        /* Timer Flash Overlay */
        @keyframes timerFlash {
            0% {
                opacity: 0;
            }

            25% {
                opacity: 0.8;
            }

            50% {
                opacity: 0;
            }

            75% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
            }
        }

        .timer-flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 9999;
            pointer-events: none;
            animation: timerFlash 1s ease-in-out;
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            body {
                padding: 0;
                padding-bottom: 100px;
            }

            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .day-selector {
                gap: 6px;
                padding: 16px;
            }

            .day-btn {
                padding: 12px 4px;
                font-size: 11px;
            }

            .day-btn .emoji {
                font-size: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí™ GymFlow</h1>
            <div class="date" id="currentDate">Mi√©rcoles, 13 Nov 2025</div>
        </div>

        <!-- Day Selector -->
        <div class="day-selector" id="daySelector"></div>

        <!-- Workout List View -->
        <div class="workout-view" id="workoutView">
            <h2 class="workout-title" id="workoutTitle">D√çA 1 - PECHO</h2>
            <p class="workout-subtitle" id="workoutSubtitle">4 ejercicios ‚Ä¢ 16 series totales</p>
            <div class="exercise-list" id="exerciseList"></div>
            <button class="finish-workout-btn" onclick="finishWorkout()">‚úì Terminar Entrenamiento</button>

            <!-- Backup Section -->
            <div class="backup-section">
                <h3>üíæ Backup de Datos</h3>
                <div class="backup-buttons">
                    <button class="backup-btn export" onclick="exportBackup()">üì• Exportar</button>
                    <button class="backup-btn import" onclick="importBackup()">üì§ Importar</button>
                </div>
            </div>
        </div>

        <!-- Exercise Detail View -->
        <div class="exercise-view" id="exerciseView">
            <div class="exercise-header">
                <button class="back-btn" onclick="backToWorkout()">‚Üê¬ê Atr√°s</button>
                <div class="exercise-header-info">
                    <h2 id="exerciseName">Press de Banca</h2>
                    <p class="progress" id="exerciseProgress">Ejercicio 1 de 4</p>
                </div>
            </div>

            <!-- Video Section -->
            <div class="video-section" id="videoSection">
                <!-- Populated dynamically by renderVideoSection() -->
            </div>

            <!-- Current Set (LO M√ÅS IMPORTANTE - PRIMERO) -->
            <div class="current-set">
                <div class="set-number" id="setNumber">SERIE 1 de 4</div>
                <div class="set-inputs">
                    <div class="input-group">
                        <label class="input-label">Peso (kg)</label>
                        <input type="number" class="set-input" id="weightInput" placeholder="0" min="0" step="0.5"
                            inputmode="decimal">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Reps</label>
                        <input type="number" class="set-input" id="repsInput" placeholder="12" min="1"
                            inputmode="numeric">
                    </div>
                </div>
                <button class="complete-set-btn" onclick="completeSet()">‚úì Completar Serie</button>

                <!-- Rest Time Config Button -->
                <button class="rest-config-btn" onclick="showRestTimeConfig()">‚öôÔ∏è Cambiar tiempo de reposo</button>

                <!-- Rest Timer Inline -->
                <div class="rest-timer-inline" id="restTimerInline">
                    <div class="timer-display" id="timerDisplay">01:30</div>
                    <div class="timer-bar">
                        <div class="timer-bar-fill" id="timerBarFill"></div>
                    </div>
                    <div class="timer-label">‚è±Ô∏è Tiempo de descanso</div>
                </div>
            </div>

            <!-- Completed Sets -->
            <div class="completed-sets" id="completedSets">
                <h3>Series Completadas</h3>
                <div id="completedSetsList"></div>
            </div>

            <!-- Last Workout -->
            <div class="last-workout" id="lastWorkout">
                <h3>üìä √öltima vez:</h3>
                <div class="last-workout-data" id="lastWorkoutData">20kg √ó 12 reps (hace 3 d√≠as)</div>
            </div>

            <!-- Exercise Notes -->
            <div class="exercise-notes" id="exerciseNotes">
                <!-- Populated dynamically by renderExerciseNote() -->
            </div>

            <!-- Tips -->
            <div class="tips">
                <h3>üí° Consejos de T√©cnica</h3>
                <p id="exerciseTips">Mant√©n los pies firmes en el suelo y la espalda pegada al banco.</p>
            </div>
        </div>

        <!-- Summary View -->
        <div class="summary-view" id="summaryView">
            <div class="summary-icon">üéâ</div>
            <h2 class="summary-title">¬°Entrenamiento Completado!</h2>
            <p class="summary-subtitle" id="summaryDay">D√çA 1 - PECHO</p>

            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-label">Volumen Total</div>
                    <div class="summary-stat-value" id="summaryVolume">1,250 kg</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-label">Series Completadas</div>
                    <div class="summary-stat-value" id="summarySets">16 series</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-label">Duraci√≥n</div>
                    <div class="summary-stat-value" id="summaryDuration">45 min</div>
                </div>
            </div>

            <button class="back-to-home-btn" onclick="backToHome()">‚Üê¬ê Volver al Inicio</button>
        </div>
    </div>

    <!-- Floating Timer -->
    <div class="floating-timer" id="floatingTimer" onclick="skipRest()">90</div>

    <!-- Rest Time Configuration Modal -->
    <div class="modal-overlay" id="restTimeModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configurar Tiempos de Descanso</h3>
            </div>
            <div class="modal-body" id="restTimeModalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeRestTimeModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="saveRestTimeConfig()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. DATA MODEL
        // ============================================

        const ROUTINE = {
            day1: {
                name: 'D√çA 1 - PECHO',
                emoji: 'üí™',
                exercises: [
                    {
                        id: 'e1',
                        name: 'Contractor de Pecho',
                        sets: 4,
                        reps: 12,
                        rest: 60,
                        video: 'https://www.youtube.com/results?search_query=contractor+pecho+gym',
                        tips: 'Mant√©n los codos ligeramente flexionados y controla el movimiento.'
                    },
                    {
                        id: 'e2',
                        name: 'Press de Banca con Mancuernas',
                        sets: 4,
                        reps: 12,
                        rest: 60,
                        video: 'https://www.youtube.com/results?search_query=press+banca+mancuernas',
                        tips: 'Mant√©n los pies firmes en el suelo y la espalda pegada al banco.'
                    },
                    {
                        id: 'e3',
                        name: 'Apertura en Banco Inclinado',
                        sets: 4,
                        reps: 12,
                        rest: 60,
                        video: 'https://www.youtube.com/results?search_query=apertura+banco+inclinado',
                        tips: 'No bajes demasiado para evitar lesiones en el hombro.'
                    },
                    {
                        id: 'e4',
                        name: 'Pullover',
                        sets: 4,
                        reps: 12,
                        rest: 60,
                        video: 'https://www.youtube.com/results?search_query=pullover+gym',
                        tips: 'Estira bien el pecho en la fase exc√©ntrica.'
                    }
                ]
            },
            day2: {
                name: 'D√çA 2 - PIERNAS',
                emoji: 'ü¶µ',
                exercises: [
                    { id: 'e5', name: 'Extensi√≥n de Piernas', sets: 5, reps: 12, rest: 90, warmup: true, video: 'https://x.com/DSecretsOfLife/status/1972513225175437469', tips: 'Primera serie es calentamiento con peso ligero.' },
                    { id: 'e6', name: 'Prensa', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=prensa+piernas', tips: 'No bloquees las rodillas completamente en la extensi√≥n.' },
                    { id: 'e7', name: 'Sentadillas', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=sentadillas+t√©cnica', tips: 'Baja hasta que los muslos est√©n paralelos al suelo.' },
                    { id: 'e8', name: 'Hip Thrust', sets: 4, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=hip+thrust', tips: 'Aprieta los gl√∫teos en la parte superior del movimiento.' },
                    { id: 'e9', name: 'Femoral Tumbado', sets: 5, reps: 12, rest: 90, video: 'https://www.youtube.com/results?search_query=femoral+tumbado', tips: 'Controla el movimiento en ambas fases.' },
                    { id: 'e10', name: 'Aductor', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=aductor+m√°quina', tips: 'Movimiento controlado, no uses impulso.' },
                    { id: 'e11', name: 'Abductores', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=abductores+m√°quina', tips: 'Mant√©n la espalda recta durante el ejercicio.' }
                ]
            },
            day3: {
                name: 'D√çA 3 - ESPALDA',
                emoji: 'üí™',
                exercises: [
                    { id: 'e12', name: 'Jal√≥n al Pecho Agarre Ancho', sets: 4, reps: 12, rest: 60, warmup: true, video: 'https://www.youtube.com/results?search_query=jal√≥n+pecho+agarre+ancho', tips: 'Primera serie es calentamiento. Tira con los codos, no con las manos.' },
                    { id: 'e13', name: 'Remo Bajo en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=remo+bajo+polea', tips: 'Mant√©n la espalda recta y aprieta las esc√°pulas al final.' },
                    { id: 'e14', name: 'Remo en Banco con Mancuernas', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=remo+banco+mancuernas', tips: 'El codo debe subir m√°s alto que la espalda.' },
                    { id: 'e15', name: 'Pullover en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=pullover+polea+espalda', tips: 'Mant√©n los brazos ligeramente flexionados.' }
                ]
            },
            day4: {
                name: 'D√çA 4 - B√çCEPS Y HOMBRO',
                emoji: 'üí™',
                exercises: [
                    { id: 'e16', name: 'La Vuelta al Mundo', sets: 4, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=vuelta+al+mundo+hombros', tips: 'Movimiento circular completo y controlado.' },
                    { id: 'e17', name: 'Elevaciones Laterales', sets: 3, reps: 15, rest: 60, video: 'https://www.youtube.com/results?search_query=elevaciones+laterales', tips: 'No subas m√°s arriba de los hombros.' },
                    { id: 'e18', name: 'Elevaciones Frontales', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=elevaciones+frontales', tips: 'Mant√©n el core activado para evitar balanceo.' },
                    { id: 'e19', name: 'Press de Hombro en M√°quina', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=press+hombro+m√°quina', tips: 'Empuja hacia arriba sin bloquear los codos.' },
                    { id: 'e20', name: 'P√°jaro M√°quina Peck Deck', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=p√°jaro+m√°quina', tips: 'Aprieta las esc√°pulas al final del movimiento.' },
                    { id: 'e21', name: 'Jal√≥n al Ment√≥n', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=jal√≥n+ment√≥n', tips: 'Los codos deben ir m√°s altos que las manos.' }
                ]
            },
            day5: {
                name: 'D√çA 5 - B√çCEPS Y TR√çCEPS',
                emoji: 'üí™',
                exercises: [
                    { id: 'e22', name: 'Curl de B√≠ceps con Mancuerna', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+b√≠ceps+mancuerna', tips: 'No balancees el cuerpo, solo mueve el antebrazo.' },
                    { id: 'e23', name: 'Curl de B√≠cep en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+b√≠ceps+polea', tips: 'Mant√©n los codos pegados al cuerpo.' },
                    { id: 'e24', name: 'Martillo', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=curl+martillo', tips: 'Agarre neutral, como si sostuvieras un martillo.' },
                    { id: 'e25', name: 'Tr√≠ceps con Cuerda en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=tr√≠ceps+cuerda+polea', tips: 'Separa la cuerda al final del movimiento.' },
                    { id: 'e26', name: 'Trasnuca con Mancuerna', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=trasnuca+mancuerna+tr√≠ceps', tips: 'Mant√©n el codo apuntando hacia arriba.' },
                    { id: 'e27', name: 'Tr√≠ceps con Barra Z en Polea', sets: 3, reps: 12, rest: 60, video: 'https://www.youtube.com/results?search_query=tr√≠ceps+barra+z', tips: 'Codos pegados al cuerpo durante todo el movimiento.' }
                ]
            }
        };

        // ============================================
        // 2. STATE MANAGEMENT
        // ============================================

        let currentDay = 'day1';
        let currentExerciseId = null;
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let workoutStartTime = null;
        let timerInterval = null;
        let workoutData = {};

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('gymflow-data');
            if (saved) {
                workoutData = JSON.parse(saved);
            }
        }

        // Auto-save (como behavioral-activation)
        function autoSave() {
            localStorage.setItem('gymflow-data', JSON.stringify(workoutData));
        }

        // ============================================
        // 3. INITIALIZATION
        // ============================================

        function init() {
            loadData();
            updateCurrentDate();
            renderDaySelector();
            loadWorkoutView();
            loadExerciseNotes();
        }

        function updateCurrentDate() {
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const now = new Date();
            const dateStr = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // ============================================
        // 4. DAY SELECTOR
        // ============================================

        function renderDaySelector() {
            const container = document.getElementById('daySelector');
            const days = ['day1', 'day2', 'day3', 'day4', 'day5'];

            container.innerHTML = days.map(day => {
                const dayData = ROUTINE[day];
                const dayNum = day.replace('day', '');
                return `
                    <button 
                        class="day-btn ${day === currentDay ? 'active' : ''}"
                        onclick="changeDay('${day}')"
                    >
                        <span class="emoji">${dayData.emoji}</span>
                        D√≠a ${dayNum}
                    </button>
                `;
            }).join('');
        }

        function changeDay(day) {
            currentDay = day;
            renderDaySelector();
            loadWorkoutView();
        }

        // ============================================
        // 5. WORKOUT VIEW
        // ============================================

        function loadWorkoutView() {
            const dayData = ROUTINE[currentDay];
            const todayKey = getTodayKey();
            const todayData = workoutData[todayKey] || { day: currentDay, exercises: {} };

            document.getElementById('workoutTitle').textContent = dayData.name;

            const totalSets = dayData.exercises.reduce((sum, ex) => sum + ex.sets, 0);
            document.getElementById('workoutSubtitle').textContent =
                `${dayData.exercises.length} ejercicios ‚Ä¢ ${totalSets} series totales`;

            const exerciseListHtml = dayData.exercises.map((exercise, index) => {
                const exerciseData = todayData.exercises[exercise.id] || { sets: [] };
                const completedSets = exerciseData.sets.length;
                const isCompleted = completedSets >= exercise.sets;
                const isActive = currentExerciseId === exercise.id;

                let status = '‚ö™';
                if (isCompleted) status = '‚úÖ';
                else if (isActive) status = '‚ñ∂Ô∏è¬è';

                let lastWorkout = '';
                if (completedSets > 0) {
                    const lastSet = exerciseData.sets[completedSets - 1];
                    lastWorkout = `<div class="exercise-last">√öltima: ${lastSet.weight}kg √ó ${lastSet.reps} reps</div>`;
                }

                return `
                    <div class="exercise-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}" 
                         onclick="startExercise('${exercise.id}', ${index})">
                        <div class="exercise-status">${status}</div>
                        <div class="exercise-info">
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-details">
                                ${completedSets}/${exercise.sets} series ‚Ä¢ ${exercise.reps} reps
                                ${exercise.warmup ? ' ‚Ä¢ üî• Calentamiento' : ''}
                            </div>
                            ${lastWorkout}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('exerciseList').innerHTML = exerciseListHtml;

            // Show/hide views
            document.getElementById('workoutView').classList.remove('hidden');
            document.getElementById('exerciseView').classList.add('hidden');
            document.getElementById('summaryView').classList.remove('active');
        }

        // ============================================
        // 6. EXERCISE VIEW
        // ============================================

        function startExercise(exerciseId, index) {
            currentExerciseId = exerciseId;
            currentExerciseIndex = index;

            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === exerciseId);
            const todayKey = getTodayKey();
            const todayData = workoutData[todayKey] || { day: currentDay, exercises: {} };
            const exerciseData = todayData.exercises[exerciseId] || { sets: [] };

            currentSetNumber = exerciseData.sets.length + 1;

            if (currentSetNumber > exercise.sets) {
                // Exercise already completed, but allow viewing
                currentSetNumber = exercise.sets;
            }

            // Update UI
            document.getElementById('exerciseName').textContent = exercise.name;
            document.getElementById('exerciseProgress').textContent =
                `Ejercicio ${index + 1} de ${dayData.exercises.length}`;
            document.getElementById('exerciseTips').textContent = exercise.tips;
            document.getElementById('setNumber').textContent =
                `SERIE ${currentSetNumber} de ${exercise.sets}`;

            // Render video section
            renderVideoSection(exercise.video);

            // Show last workout reference
            const lastWorkoutEl = document.getElementById('lastWorkout');
            const lastWorkoutData = getLastWorkoutForExercise(exerciseId);
            if (lastWorkoutData) {
                lastWorkoutEl.classList.remove('hidden');
                const daysAgo = Math.floor((Date.now() - new Date(lastWorkoutData.date).getTime()) / (1000 * 60 * 60 * 24));
                const avgWeight = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.weight, 0) / lastWorkoutData.sets.length);
                const avgReps = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.reps, 0) / lastWorkoutData.sets.length);
                document.getElementById('lastWorkoutData').textContent =
                    `${avgWeight}kg √ó ${avgReps} reps (hace ${daysAgo} d√≠as)`;
            } else {
                lastWorkoutEl.classList.add('hidden');
            }

            // Auto-fill weight and reps inputs
            if (exerciseData.sets.length > 0) {
                // Use last set from TODAY
                const lastSet = exerciseData.sets[exerciseData.sets.length - 1];
                document.getElementById('weightInput').value = lastSet.weight;
                document.getElementById('repsInput').value = lastSet.reps;
            } else if (lastWorkoutData) {
                // Use average from LAST WORKOUT
                const avgWeight = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.weight, 0) / lastWorkoutData.sets.length);
                const avgReps = Math.round(lastWorkoutData.sets.reduce((sum, s) => sum + s.reps, 0) / lastWorkoutData.sets.length);
                document.getElementById('weightInput').value = avgWeight;
                document.getElementById('repsInput').value = avgReps;
            } else {
                // No previous data - use defaults
                document.getElementById('weightInput').value = '';
                document.getElementById('repsInput').value = exercise.reps;
            }

            // Render completed sets
            renderCompletedSets(exerciseData.sets);

            // Show/hide views
            document.getElementById('workoutView').classList.add('hidden');
            document.getElementById('exerciseView').classList.remove('hidden');
            document.getElementById('exerciseView').classList.add('active');

            // Hide rest timer
            document.getElementById('restTimerInline').classList.remove('active');

            // Start workout timer if first exercise
            if (!workoutStartTime) {
                workoutStartTime = Date.now();
            }

            // Render exercise note
            renderExerciseNote(exerciseId);
        }

        function renderCompletedSets(sets) {
            const container = document.getElementById('completedSetsList');
            if (sets.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-600); font-size: 14px;">No hay series completadas a√∫n</p>';
                return;
            }

            let html = sets.map((set, index) => `
                <div class="completed-set">
                    <span class="set-label">Serie ${index + 1}</span>
                    <span class="set-data">${set.weight}kg √ó ${set.reps} reps</span>
                    <span class="set-time">${new Date(set.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
            `).join('');

            // Add delete last set button
            html += '<button class="delete-last-set-btn" onclick="deleteLastSet()">üóëÔ∏è Borrar √∫ltima serie</button>';

            container.innerHTML = html;
        }

        function renderVideoSection(videoUrl) {
            const container = document.getElementById('videoSection');

            // Detect video type
            const isTwitter = videoUrl.includes('twitter.com') || videoUrl.includes('x.com');
            const isYouTube = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be');

            if (isTwitter) {
                // Extract tweet ID from URL
                const tweetId = extractTweetId(videoUrl);
                if (tweetId) {
                    container.innerHTML = `
                        <div class="video-embed-container" id="twitterEmbed-${tweetId}">
                            <div style="color: var(--gray-600); font-size: 14px;">Cargando video...</div>
                        </div>
                        <a class="video-link twitter" href="${videoUrl}" target="_blank">üê¶ Ver en X/Twitter</a>
                    `;

                    // Load Twitter embed
                    loadTwitterEmbed(tweetId);
                } else {
                    // Fallback if can't extract ID
                    container.innerHTML = `
                        <div class="placeholder">üé•</div>
                        <a class="video-link twitter" href="${videoUrl}" target="_blank">üê¶ Ver en X/Twitter</a>
                    `;
                }
            } else if (isYouTube) {
                // YouTube - show link (can be upgraded to iframe embed later)
                container.innerHTML = `
                    <div class="placeholder">üé•</div>
                    <a class="video-link" href="${videoUrl}" target="_blank">üì∫ Ver T√©cnica en YouTube</a>
                `;
            } else {
                // Generic video link
                container.innerHTML = `
                    <div class="placeholder">üé•</div>
                    <a class="video-link" href="${videoUrl}" target="_blank">üé• Ver Video de T√©cnica</a>
                `;
            }
        }

        function extractTweetId(url) {
            // Extract tweet ID from various Twitter/X URL formats
            const patterns = [
                /status\/(\d+)/,           // https://twitter.com/user/status/123456
                /\/(\d+)(?:\?|$)/,         // https://x.com/user/status/123456?s=20
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }

            return null;
        }

        function loadTwitterEmbed(tweetId) {
            // Wait for Twitter SDK to load
            if (typeof twttr === 'undefined') {
                setTimeout(() => loadTwitterEmbed(tweetId), 500);
                return;
            }

            const container = document.getElementById(`twitterEmbed-${tweetId}`);
            if (!container) return;

            // Clear loading message
            container.innerHTML = '';

            // Create tweet embed
            twttr.widgets.createTweet(
                tweetId,
                container,
                {
                    theme: 'light',
                    cards: 'visible',
                    conversation: 'none',
                    align: 'center',
                    width: 550
                }
            ).then((el) => {
                if (!el) {
                    container.innerHTML = '<div style="color: var(--danger); font-size: 14px;">Error al cargar el video</div>';
                }
            });
        }

        function deleteLastSet() {
            // Show confirmation dialog
            if (!confirm('¬øSeguro que quieres borrar la √∫ltima serie?')) {
                return;
            }

            const todayKey = getTodayKey();
            const exerciseData = workoutData[todayKey]?.exercises[currentExerciseId];

            if (!exerciseData || exerciseData.sets.length === 0) {
                alert('‚ö†Ô∏è No hay series para borrar');
                return;
            }

            // Remove last set
            exerciseData.sets.pop();

            // Decrement current set number
            currentSetNumber = exerciseData.sets.length + 1;

            // Save changes
            autoSave();

            // Stop rest timer if active
            stopRestTimer();

            // Update UI
            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            document.getElementById('setNumber').textContent =
                `SERIE ${currentSetNumber} de ${exercise.sets}`;
            renderCompletedSets(exerciseData.sets);

            // If all sets were deleted, refresh workout view
            if (exerciseData.sets.length === 0) {
                loadWorkoutView();
            }
        }

        function completeSet() {
            const weight = parseFloat(document.getElementById('weightInput').value);
            const reps = parseInt(document.getElementById('repsInput').value);

            if (!weight || weight <= 0 || !reps || reps <= 0) {
                alert('‚ö†Ô∏è¬è Por favor ingresa peso y reps v√°lidos');
                return;
            }

            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);
            const todayKey = getTodayKey();

            // Initialize data structure if needed
            if (!workoutData[todayKey]) {
                workoutData[todayKey] = { day: currentDay, exercises: {}, date: todayKey };
            }
            if (!workoutData[todayKey].exercises[currentExerciseId]) {
                workoutData[todayKey].exercises[currentExerciseId] = { sets: [] };
            }

            // Add set
            workoutData[todayKey].exercises[currentExerciseId].sets.push({
                weight,
                reps,
                timestamp: new Date().toISOString()
            });

            autoSave();

            // Update UI
            currentSetNumber++;
            const exerciseData = workoutData[todayKey].exercises[currentExerciseId];

            if (currentSetNumber <= exercise.sets) {
                // More sets remaining
                document.getElementById('setNumber').textContent =
                    `SERIE ${currentSetNumber} de ${exercise.sets}`;
                renderCompletedSets(exerciseData.sets);

                // Start rest timer with custom rest time if available
                const customRestTimes = exerciseData.customRestTimes || [];
                const previousSetIndex = currentSetNumber - 2; // The set we just completed (0-indexed)
                const restTime = customRestTimes[previousSetIndex] || exercise.rest;
                startRestTimer(restTime);
            } else {
                // Exercise completed
                renderCompletedSets(exerciseData.sets);

                // Show completion message
                setTimeout(() => {
                    alert('‚úÖ ¬°Ejercicio completado!');
                    backToWorkout();
                }, 500);
            }
        }

        function backToWorkout() {
            currentExerciseId = null;
            document.getElementById('exerciseView').classList.remove('active');
            loadWorkoutView();
            stopRestTimer();
        }

        // ============================================
        // 7. REST TIMER
        // ============================================

        function startRestTimer(seconds) {
            stopRestTimer(); // Clear any existing timer

            const timerDisplay = document.getElementById('timerDisplay');
            const timerBarFill = document.getElementById('timerBarFill');
            const restTimerInline = document.getElementById('restTimerInline');

            restTimerInline.classList.add('active');

            // Use timestamps instead of counter for background-safe timing
            const startTime = Date.now();
            const endTime = startTime + (seconds * 1000);
            const totalDuration = seconds * 1000;

            function updateTimer() {
                const now = Date.now();
                const remainingMs = Math.max(0, endTime - now);
                const remaining = Math.ceil(remainingMs / 1000);

                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                const elapsed = now - startTime;
                const percentage = Math.min(100, (elapsed / totalDuration) * 100);
                timerBarFill.style.width = percentage + '%';

                if (remainingMs <= 0) {
                    stopRestTimer();
                    restTimerInline.classList.remove('active');

                    // Improved Vibration (more distinctive pattern)
                    try {
                        if ('vibrate' in navigator) {
                            navigator.vibrate([400, 200, 400, 200, 600]);
                        }
                    } catch (e) {
                        console.warn('Vibration failed:', e);
                    }

                    // Visual Flash (essential for iOS - no vibration support)
                    try {
                        const flash = document.createElement('div');
                        flash.className = 'timer-flash-overlay';
                        document.body.appendChild(flash);
                        setTimeout(() => flash.remove(), 1000);
                    } catch (e) {
                        console.warn('Visual flash failed:', e);
                    }

                    // Audio Beep (800 Hz tone for 0.5s)
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.warn('Audio beep failed:', e);
                    }

                    // Notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('‚è∞ Descanso terminado', {
                            body: '¬°Listo para la siguiente serie!',
                            icon: '/gymrat/icons/icon-192.png'
                        });
                    }
                }

            }

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }


        function stopRestTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('restTimerInline').classList.remove('active');
        }

        function skipRest() {
            stopRestTimer();
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ============================================
        // 7.5. CUSTOM REST TIME CONFIGURATION
        // ============================================

        function showRestTimeConfig() {
            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);

            if (!exercise) return;

            const todayKey = getTodayKey();
            const todayData = workoutData[todayKey] || { day: currentDay, exercises: {} };
            const exerciseData = todayData.exercises[currentExerciseId] || { sets: [] };

            // Get existing custom rest times or use default
            const customRestTimes = exerciseData.customRestTimes || [];

            // Determine default rest time based on exercise
            const defaultRest = exercise.rest;

            // Generate modal content
            let modalContent = '<p style="margin-bottom: 16px; color: var(--gray-600); font-size: 14px;">Configura el tiempo de descanso para cada serie (en segundos).</p>';

            for (let i = 0; i < exercise.sets; i++) {
                const restTime = customRestTimes[i] || defaultRest;
                modalContent += `
                    <div class="rest-config-item">
                        <span class="rest-config-label">Serie ${i + 1}</span>
                        <input
                            type="number"
                            class="rest-config-input"
                            id="restTime-${i}"
                            value="${restTime}"
                            min="0"
                            max="600"
                            step="5"
                        />
                        <span style="margin-left: 8px; color: var(--gray-600); font-size: 14px;">seg</span>
                    </div>
                `;
            }

            document.getElementById('restTimeModalBody').innerHTML = modalContent;
            document.getElementById('restTimeModal').classList.add('active');
        }

        function closeRestTimeModal() {
            document.getElementById('restTimeModal').classList.remove('active');
        }

        function saveRestTimeConfig() {
            const dayData = ROUTINE[currentDay];
            const exercise = dayData.exercises.find(ex => ex.id === currentExerciseId);

            if (!exercise) return;

            const todayKey = getTodayKey();

            // Initialize data structure if needed
            if (!workoutData[todayKey]) {
                workoutData[todayKey] = { day: currentDay, exercises: {}, date: todayKey };
            }
            if (!workoutData[todayKey].exercises[currentExerciseId]) {
                workoutData[todayKey].exercises[currentExerciseId] = { sets: [] };
            }

            // Collect custom rest times
            const customRestTimes = [];
            for (let i = 0; i < exercise.sets; i++) {
                const input = document.getElementById(`restTime-${i}`);
                const restTime = parseInt(input.value) || exercise.rest;
                customRestTimes.push(restTime);
            }

            // Save to workout data
            workoutData[todayKey].exercises[currentExerciseId].customRestTimes = customRestTimes;
            autoSave();

            // Close modal
            closeRestTimeModal();

            // Show confirmation
            alert('‚úÖ Tiempos de descanso configurados correctamente');
        }

        // ============================================
        // 8. WORKOUT SUMMARY
        // ============================================

        function finishWorkout() {
            const todayKey = getTodayKey();
            const todayData = workoutData[todayKey];

            if (!todayData || Object.keys(todayData.exercises).length === 0) {
                alert('‚ö†Ô∏è¬è No has completado ning√∫n ejercicio a√∫n');
                return;
            }

            // Calculate stats
            let totalVolume = 0;
            let totalSets = 0;

            Object.values(todayData.exercises).forEach(exerciseData => {
                exerciseData.sets.forEach(set => {
                    totalVolume += set.weight * set.reps;
                    totalSets++;
                });
            });

            const durationMinutes = workoutStartTime ?
                Math.round((Date.now() - workoutStartTime) / (1000 * 60)) : 0;

            // Update UI
            const dayData = ROUTINE[currentDay];
            document.getElementById('summaryDay').textContent = dayData.name;
            document.getElementById('summaryVolume').textContent = totalVolume.toLocaleString('es-ES') + ' kg';
            document.getElementById('summarySets').textContent = totalSets + ' series';
            document.getElementById('summaryDuration').textContent = durationMinutes + ' min';

            // Show summary view
            document.getElementById('workoutView').classList.add('hidden');
            document.getElementById('exerciseView').classList.remove('active');
            document.getElementById('summaryView').classList.add('active');

            // Reset workout start time
            workoutStartTime = null;
        }

        function backToHome() {
            document.getElementById('summaryView').classList.remove('active');
            loadWorkoutView();
        }

        // ============================================
        // 9. EXERCISE NOTES
        // ============================================

        let exerciseNotes = {};
        let saveNoteTimeout = null;

        // Load exercise notes from localStorage
        function loadExerciseNotes() {
            const saved = localStorage.getItem('gymflow-exercise-notes');
            if (saved) {
                try {
                    exerciseNotes = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading exercise notes:', e);
                    exerciseNotes = {};
                }
            }
        }

        // Save exercise notes to localStorage
        function saveExerciseNotes() {
            localStorage.setItem('gymflow-exercise-notes', JSON.stringify(exerciseNotes));
        }

        // Render exercise note section
        function renderExerciseNote(exerciseId) {
            const container = document.getElementById('exerciseNotes');
            const note = exerciseNotes[exerciseId] || '';
            const hasNote = note.trim().length > 0;

            if (hasNote) {
                // Show existing note with edit button
                container.innerHTML = `
                    <div class="exercise-note-box">
                        <div class="exercise-note-header">
                            <h3>üìù Mis Notas</h3>
                            <button class="exercise-note-edit-btn" onclick="toggleEditNote('${exerciseId}')">‚úèÔ∏è Editar</button>
                        </div>
                        <div class="exercise-note-text" id="noteText-${exerciseId}">${note}</div>
                        <textarea
                            class="exercise-note-textarea hidden"
                            id="noteTextarea-${exerciseId}"
                            placeholder="Ej: Sent√≠ buena activaci√≥n | Pr√≥xima semana 25kg | Ajuste 3 funciona mejor"
                            maxlength="500"
                            oninput="onNoteInput('${exerciseId}')"
                        >${note}</textarea>
                    </div>
                `;
            } else {
                // Show add note button
                container.innerHTML = `
                    <button class="exercise-note-add-btn" onclick="showNoteEditor('${exerciseId}')">
                        + A√±adir nota
                    </button>
                `;
            }
        }

        // Toggle edit mode for note
        function toggleEditNote(exerciseId) {
            const textDiv = document.getElementById(`noteText-${exerciseId}`);
            const textarea = document.getElementById(`noteTextarea-${exerciseId}`);
            const editBtn = event.target;

            if (textarea.classList.contains('hidden')) {
                // Enter edit mode
                textDiv.classList.add('hidden');
                textarea.classList.remove('hidden');
                textarea.focus();
                editBtn.textContent = '‚úì Guardar';
            } else {
                // Exit edit mode
                textDiv.classList.remove('hidden');
                textarea.classList.add('hidden');
                editBtn.textContent = '‚úèÔ∏è Editar';

                // Update displayed text
                textDiv.textContent = textarea.value;
            }
        }

        // Show note editor for new note
        function showNoteEditor(exerciseId) {
            const container = document.getElementById('exerciseNotes');
            container.innerHTML = `
                <div class="exercise-note-box">
                    <div class="exercise-note-header">
                        <h3>üìù Mis Notas</h3>
                    </div>
                    <textarea
                        class="exercise-note-textarea"
                        id="noteTextarea-${exerciseId}"
                        placeholder="Ej: Sent√≠ buena activaci√≥n | Pr√≥xima semana 25kg | Ajuste 3 funciona mejor"
                        maxlength="500"
                        oninput="onNoteInput('${exerciseId}')"
                        autofocus
                    ></textarea>
                </div>
            `;

            // Focus textarea
            setTimeout(() => {
                document.getElementById(`noteTextarea-${exerciseId}`).focus();
            }, 100);
        }

        // Handle note input with debounced save
        function onNoteInput(exerciseId) {
            const textarea = document.getElementById(`noteTextarea-${exerciseId}`);
            const noteText = textarea.value.trim();

            // Clear existing timeout
            if (saveNoteTimeout) {
                clearTimeout(saveNoteTimeout);
            }

            // Save after 500ms of no typing
            saveNoteTimeout = setTimeout(() => {
                if (noteText.length > 0) {
                    exerciseNotes[exerciseId] = noteText;
                } else {
                    delete exerciseNotes[exerciseId];
                }
                saveExerciseNotes();
            }, 500);
        }

        // ============================================
        // 10. UTILITY FUNCTIONS
        // ============================================

        function getTodayKey() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function getLastWorkoutForExercise(exerciseId) {
            const todayKey = getTodayKey();
            const sortedDates = Object.keys(workoutData)
                .filter(date => date !== todayKey)
                .sort()
                .reverse();

            for (const date of sortedDates) {
                const workout = workoutData[date];
                if (workout.exercises[exerciseId] && workout.exercises[exerciseId].sets.length > 0) {
                    return {
                        date,
                        sets: workout.exercises[exerciseId].sets
                    };
                }
            }

            return null;
        }

        // ============================================
        // 11. BACKUP / RESTORE
        // ============================================

        function exportBackup() {
            const data = {
                workoutData: workoutData,
                exerciseNotes: exerciseNotes,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gymflow-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Backup exportado correctamente a tu carpeta de Descargas');
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Validate data structure
                        if (!data.workoutData && !data.exerciseNotes) {
                            alert('‚ùå Archivo de backup no v√°lido');
                            return;
                        }

                        // Confirm before overwriting
                        const confirm = window.confirm(
                            '‚ö†Ô∏è ¬øEst√°s seguro de importar este backup?\n\n' +
                            'Esto SOBRESCRIBIR√Å todos tus datos actuales.\n\n' +
                            'Si tienes datos importantes, exporta un backup primero.'
                        );

                        if (!confirm) return;

                        // Import data
                        if (data.workoutData) {
                            workoutData = data.workoutData;
                            localStorage.setItem('gymflow-data', JSON.stringify(workoutData));
                        }

                        if (data.exerciseNotes) {
                            exerciseNotes = data.exerciseNotes;
                            localStorage.setItem('gymflow-exercise-notes', JSON.stringify(exerciseNotes));
                        }

                        alert('‚úÖ Backup importado correctamente. La p√°gina se recargar√°.');

                        // Reload page to reflect changes
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);

                    } catch (error) {
                        console.error('Error importing backup:', error);
                        alert('‚ùå Error al importar el backup. Verifica que el archivo sea v√°lido.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================
        // 12. INIT APP
        // ============================================

        init();

        // Prevent accidental page refresh
        window.addEventListener('beforeunload', (e) => {
            if (currentExerciseId) {
                e.preventDefault();
                e.returnValue = 'Tienes un entreno en progreso. ¬øSeguro que quieres salir?';
            }
        });

        console.log('üöÄ GymFlow iniciado correctamente');
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gymrat/service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>

</html>